<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="/jquery-3.7.1.js"></script>
    <style>
        img {
            width: 200px
        }
    </style>
</head>

<body>
    <br><br><br><br><br><br><br><br><br><br>
    <!-- 最大的div 包含所有商品的 -->
    <div style="border: solid rgb(179, 179, 179) 2px; padding: 30px;">
        <p style="font-size: 26px;">好市集好市集好市集</p>
        <div style="border: solid yellowgreen 1px;">
            <% for (item of products) { %>
            <div style="border-bottom: solid 2px rgb(179, 179, 179);
            margin-bottom: 10px; margin: 20px;">
                <div style="display: flex;" data-stock="<%= item.quantity %>">
                    <img src="<%= `data:image/jpeg;base64,${Buffer.from(item.img01).toString('base64')}` %>" style="" alt="">
                    <div>
                        <h3><%= item.name %></h3>
                        <span class="price">售價: $ <%= item.price %></span>
                        <br><br>
                        <span>剩餘數量:<%= item.quantity %></span>
                    </div>
    
                </div>
                <div style="display: flex;">
                    <span style="flex: 1;"> 數量</span>
                    <span style="flex: 1;"> 小計</span>
                </div>
                <div style="display: flex; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <button class="btnMinus" id="btn">-</button>
                        <input type="text" style="width: 80px; height: 30px; text-align: center; " value="<%= item.amount %>">
                        <button class="btnPlus">+</button>
                    </div>
                    <div style="flex: 1;">
                        <span class="subtotal"><%= turnPrice(item.amount * item.price) %> 元</span>
                    </div>
                </div>
            </div>
            <% } %>
            
            <!-- <div style="border-bottom: solid 2px rgb(179, 179, 179);
            margin-bottom: 10px; margin: 20px;">
                <div style="display: flex;" data-stock="10">
                    <img src="../IU-New-Balance-Foot-Locker-Exclusive-Collection-3.jpeg" alt="">
                    <div>
                        <h3>I</h3>
                        <span>售價: $3,280</span>
                        <br><br>
                        <span>剩餘數量:10</span>
                    </div>
    
                </div>
                <div style="display: flex;">
                    <span style="flex: 1;"> 數量</span>
                    <span style="flex: 1;"> 小計</span>
                </div>
                <div style="display: flex; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <button class="btnMinus">-</button>
                        <input type="text" style="width: 80px; height: 30px; text-align: center; " value="1">
                        <button class="btnPlus">+</button>
                    </div>
                    <div style="flex: 1;">
                        <span>$ 1000</span>
                    </div>
                </div>
            </div> -->
            
        </div>
    </div>

    <div style=" background-color: gray; margin-top: 20px;
    padding: 30px;display: flex; justify-content: space-between;
    align-items: center;">
        <span id="totalPrice">$ 1000</span>
        <button style="width: 50px; height: 50px;">結帳</button>
    </div>
    
    <script>
        $(document).ready(function() {
            // 卡片減號功能
            $('.btnMinus').click(function () {
                let num = parseInt($(this).parent().find('input').val());
                $(this).parent().find('input').val(num > 1 ? num - 1 : num);
                updateSubtotal.call(this);
                updateTotal();
            });

            // 卡片加號功能
            $('.btnPlus').click(function () {
                let num = parseInt($(this).parent().find('input').val());
                let maxStock = $(this).parent().parent().parent().find('div').data('stock');
                    if (!isNaN(num) && num < maxStock) {
                        $(this).parent().find('input').val(num + 1);
                    }
                updateSubtotal.call(this);
                updateTotal();
            });

            $('.price').each(function() {
                var priceText = $(this).text().replace(/[^\d]/g, '');
                $(this).text('售價: ' + turnPrice(priceText));
                });

            function turnPrice(price) {
                return Number(price).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
                });
            }

            function updateSubtotal() {
                let subtotal = 0;
                let amount = $(this).parent().find('input').val();
                let subtotalText = $(this).parent().parent().parent().find('.price').text();
                let newSubtotalText = subtotalText.replace(/[^\d]/g, '');
                // console.log(newSubtotalText);
                subtotal += (newSubtotalText * amount);
                $(this).parent().parent().find('.subtotal').text(turnPrice(`${subtotal}`)+'元');
            }

            function updateTotal(){
                let total = 0;
                $('.subtotal').each(function() {
                    let priceText = $(this).text().replace(/[^\d]/g, '');
                    total += parseInt(priceText);
                });
                $('#totalPrice').text('總金額 : ' + turnPrice(`${total}`)+'元');
            }

        });
    </script>
</body>

</html>